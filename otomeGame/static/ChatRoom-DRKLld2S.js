import{u as D,S as H,P as R,W as L,d as N,M as U,D as E,e as P,c as W}from"./api-BG-G1cP5.js";import{_ as A,r as p,k as F,s as G,w as q,c as f,b as o,f as h,I as K,a as k,t as w,d as $,F as j,e as J,L as O,g as S,i as Q,p as X,o as y,n as Y,h as Z,j as M}from"./index-C80g6NUL.js";const ee={class:"chat-container"},ae={class:"character-header"},te={class:"character-name"},se={class:"message-content"},oe={class:"message-time"},ne={key:0,class:"message ai-message loading-indicator"},re={class:"message-bubble loading-bubble"},ce={class:"input-area"},le={__name:"ChatRoom",setup(ie){const T=G(),z=X(),x=D(),d=p({});F(()=>{B();const a=T.query.character;if(a){const e=x.characters.find(t=>t.name===a);e&&(d.value=e,console.log(d.value),x.selectCharacter(e))}});const B=()=>{const a=document.getElementById("bg"),e=new H,t=new R(75,a.clientWidth/a.clientHeight,.1,1e3),s=new L({alpha:!0});s.setSize(a.clientWidth,a.clientHeight),a.appendChild(s.domElement);const m=new N(.2,.4),C=new U({color:16752309,transparent:!0,opacity:.7,side:E}),g=[],c=200;for(let l=0;l<c;l++){const u=new P(m,C);u.position.x=(Math.random()-.5)*100,u.position.y=Math.random()*50,u.position.z=(Math.random()-.5)*100,u.rotation.z=Math.random()*Math.PI*2,g.push(u),e.add(u)}t.position.z=30;const _=()=>{requestAnimationFrame(_),g.forEach(l=>{l.position.y-=.1,l.rotation.z+=.01,l.position.y<-25&&(l.position.y=25)}),s.render(e,t)};_()},n=p([]),i=p(""),r=p(null),v=p(!1),b=a=>`${a.getHours()}:${a.getMinutes().toString().padStart(2,"0")}`,V=()=>{console.log("goBack clicked"),z.back()},I=async()=>{if(!i.value.trim())return;v.value=!0,n.value.push({content:i.value,isUser:!0,time:b(new Date)});const a=i.value;i.value="";try{const e=await W({character:d.value.name,message:a}),t={content:"",isUser:!1,time:b(new Date),isTyping:!0};n.value.push(t);let s=0;const m=setInterval(()=>{s<e.data.length?(t.content+=e.data.charAt(s),s++,n.value=[...n.value],M(()=>{r.value.scrollTop=r.value.scrollHeight})):(clearInterval(m),t.isTyping=!1)},50);M(()=>{r.value.scrollTop=r.value.scrollHeight}),v.value=!1}catch(e){console.error("聊天出错:",e),v.value=!1,n.value.push({content:"对话服务暂时不可用，请稍后再试",isUser:!1,time:b(new Date)})}};return q(n,()=>{M(()=>{r.value.scrollTop=r.value.scrollHeight})},{deep:!0}),(a,e)=>{const t=K,s=k("el-avatar"),m=O,C=k("el-button"),g=k("el-input");return y(),f("div",ee,[o("div",ae,[h(t,{name:"arrow-left",class:"back-button",onClick:V}),h(s,{size:60,src:d.value.image,class:"character-avatar"},null,8,["src"]),o("h2",te,w(d.value.name),1)]),o("div",{class:"message-area",ref_key:"messageContainer",ref:r},[e[1]||(e[1]=o("div",{id:"bg",class:"ChatRoombackground"},null,-1)),(y(!0),f(j,null,J(n.value,(c,_)=>(y(),f("div",{key:_,class:Y(["message-bubble",{"user-message":c.isUser}])},[o("div",se,w(c.content),1),o("div",oe,w(c.time),1)],2))),128)),v.value?(y(),f("div",ne,[o("div",re,[h(m,{color:"pink"})])])):$("",!0)],512),o("div",ce,[h(g,{modelValue:i.value,"onUpdate:modelValue":e[0]||(e[0]=c=>i.value=c),placeholder:"输入消息...",onKeyup:Q(I,["enter"]),class:"message-input"},{append:S(()=>[h(C,{type:"primary",onClick:I},{default:S(()=>e[2]||(e[2]=[Z("发送")])),_:1})]),_:1},8,["modelValue"])])])}}},me=A(le,[["__scopeId","data-v-7480272d"]]);export{me as default};
